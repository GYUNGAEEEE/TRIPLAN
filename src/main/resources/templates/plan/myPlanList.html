<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="/css/plan/myPlanListStyle.css">

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // 현재 날짜를 얻습니다.
            const today = new Date();
            today.setHours(0, 0, 0, 0); // 시간을 00:00:00으로 설정하여 정확한 비교를 합니다.

            // 모든 dDay 요소를 선택합니다.
            const startDayElements = document.querySelectorAll('.startDay');

            // 각 요소를 순회하며 d-day를 계산합니다.
            startDayElements.forEach((element, index) => {
                // 요소의 텍스트 내용을 읽어와서 날짜로 변환합니다.
                const scheduleDate = new Date(element.textContent.trim());
                scheduleDate.setHours(0, 0, 0, 0); // 시간을 00:00:00으로 설정합니다.

                // d-day를 계산합니다.
                const timeDiff = scheduleDate - today;
                const dayDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24)); // 밀리초를 일수로 변환합니다.

                // 해당 요소의 하위 요소인 dDay 요소를 선택합니다.
                const dDayElement = element.parentElement.querySelector('.dDay');

                // d-day를 해당 요소에 표시합니다.
                if (dayDiff === 0) {
                    dDayElement.textContent = 'D-day';
                } else if (dayDiff > 0) {
                    dDayElement.textContent = 'D-' + dayDiff;
                } else {
                    dDayElement.textContent = 'D+' + Math.abs(dayDiff);
                }
            });
        });

        function openFileUploader(index) {
            // div 클릭 시 파일 업로드 창 열기
            document.getElementById('file_' + index).click();

            // 파일이 선택되면 form을 자동으로 제출하기
            document.getElementById('file_' + index).addEventListener('change', function() {
                document.getElementById('uploadForm_' + index).submit();
            });
        }
    </script>
</head>
<body>
    <div id="contents">
        <h2 class="mt-3 mb-3">내 여행</h2>

        <a href="/plan/write">
            <div id="addPlanBtn">
                <div>
                    <img src="/images/plus.png" alt="여행 일정 만들기" id="plus"/>
                </div>
                <div>
                    <p class="fs-4 mt-3 mb-2">여행 일정 만들기</p>
                    <p>새로운 여정을 떠나보세요.</p>
                </div>
            </div>
        </a>

        <hr/>
        <p>총 [[${planList.count}]]건</p>
        <hr/>

        <block th:each="schedule, iterStat : ${planList.scheduleList}">

            <form action="/plan/upload" method="post" enctype="multipart/form-data" th:id="'uploadForm_' + ${iterStat.index}">
                <input type="hidden" name="scheduleNo" id="scheduleNo" th:value="${schedule.scheduleNo}"/>
                <input type="file" name="uploadFile" th:id="'file_' + ${iterStat.index}" style="display:none"/>
            </form>

            <div class="planListContainer">
                <div class="planListImgBox me-3 ms-3" th:attr="onclick=|openFileUploader(${iterStat.index})|">
                    <block th:if="${planList.imageList[iterStat.index].storeName != null}">
                        <img th:src="|/plan/images/${planList.imageList[iterStat.index].storeName}|" alt="계획 섬네일" class="planListImg"/>
                    </block>
                    <block th:if="${planList.imageList[iterStat.index].storeName == null}">
                        <p class="noImg">대표 이미지를 설정해주세요.</p>
                    </block>
                </div>
                <div>
                    <a th:href="@{/plan/modify(no=${schedule.scheduleNo})}"><p class="fs-4 mb-2" th:text="${schedule.scheduleTitle}">새로운 여정</p></a>
                    <div class="dateInfo">
                        <p class="mb-5 startDay">
                            [[${#dates.format(schedule.startDay, 'yyyy-MM-dd')}]]
                        </p>
                        <p class="mb-5 endDay">
                            &nbsp;- [[${#dates.format(schedule.endDay, 'yyyy-MM-dd')}]] |&nbsp;
                        </p>
                        <p class="mb-5 dDay"></p>
                    </div>

                    <div>
                        <th:block th:each="place : ${planList.placeList.get(schedule.scheduleNo)}">
                            <span>#[[${place}]]</span>
                        </th:block>
                    </div>
                </div>
                <input type="button" class="deleteBtn" th:attr="onclick=|location.href='@{/plan/delete(no=${schedule.scheduleNo})}'|"/>
            </div>
            <hr/>

        </block>
    </div>
</body>
</html>